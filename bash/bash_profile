#!/bin/bash

stty erase 

export MJM_HOST=`hostname -s | sed -e "s/[0-9]*$//"`

if [[ $MJM_HOST == "rz"* ]]; then
  export MJM_WS=/usr/workspace/wsrzd/martymcf
elif [[ $MJM_HOST == "cztb" ]]; then
  export MJM_WS=/home/martymcf
else
  if [ -d /usr/workspace/wsb/martymcf ]; then
    export MJM_WS=/usr/workspace/wsb/martymcf
  else
    export MJM_WS=$HOME
  fi
fi

if [ ! -d $HOME/.mydotfiles/.arch_cache ]; then
  mkdir -p $HOME/.mydotfiles/.arch_cache
fi

if [ ! -f $HOME/.mydotfiles/.arch_cache/$MJM_HOST ]; then
  if [ -f $HOME/spack.$MJM_HOST/bin/spack ]; then
    $HOME/spack.$MJM_HOST/bin/spack arch > $HOME/.mydotfiles/.arch_cache/$MJM_HOST
  elif [ -f $HOME/spack/bin/spack ]; then
    $HOME/spack/bin/spack arch > $HOME/.mydotfiles/.arch_cache/$MJM_HOST
  else
    uname -m > $HOME/.mydotfiles/.arch_cache/$MJM_HOST
  fi
fi

export MJM_ARCH=`cat $HOME/.mydotfiles/.arch_cache/$MJM_HOST`

export MJM_BIN=$HOME/.bin/$MJM_ARCH

if [ -f $HOME/spack.$MJM_HOST/bin/spack ]; then
  export PATH=$HOME/spack.$MJM_HOST/bin:$PATH
elif [ -f $HOME/spack/bin/spack ]; then
  export PATH=$HOME/spack/bin:$PATH
fi

if [ -f /etc/toss-release ]; then
    MJM_TOSSVERSION=`cat /etc/toss-release`
    MJM_TOSSVERSION=${MJM_TOSSVERSION#*-}
    MJM_TOSSVERSION=${MJM_TOSSVERSION#*-}
    export MJM_TOSSVERSION=${MJM_TOSSVERSION%%.*}
else
    export MJM_TOSSVERSION=0
fi

export TMP=/tmp
export TMPDIR=$TMP
export SSH_ASKPASS=""
export EDITOR=vim

export MJM_SESSION="No Project"

export INSTALLDIR=$HOME/.session.$MJM_HOST/install/$MJM_ARCH/install
export INSTALLDIR2=$INSTALLDIR".2"
export BUILDDIR=$HOME/.session.$MJM_HOST/build/$MJM_ARCH
export SRCDIR=$HOME/.session.$MJM_HOST/src

if [ -e $HOME/.mydotfiles/bashenv/modules.$MJM_HOST ]; then
    . $HOME/.mydotfiles/bashenv/modules.$MJM_HOST
fi

if [ -e $HOME/.bashrc ]; then
	. $HOME/.bashrc
fi

for d in $HOME/.bin/$MJM_ARCH; do
  if [ ! -d $d ]; then
    if [ ! -h $d ]; then
      mkdir -p $d
    fi
  fi
done

export LD_LIBRARY_PATH=$HOME/.session.$MJM_HOST/install/$MJM_ARCH/install/lib:$HOME/.session.$MJM_HOST/install/$MJM_ARCH/install2/lib:$LD_LIBRARY_PATH
export PATH=$HOME/.session.$MJM_HOST/install/$MJM_ARCH/install/bin:$HOME/.session.$MJM_HOST/install/$MJM_ARCH/install2/bin:$MJM_BIN:$PATH:/usr/tcetmp/bin

export LIBELF_ROOT_DIR=$MJM_BIN/libelf
export LIBFFI_ROOT_DIR=$MJM_BIN/libffi

ulimit -c unlimited

if shopt | grep -q direxpand ; then 
  shopt -s direxpand
fi

SSH_ENV="$HOME/.ssh/environment"

function start_agent {
    echo "Initialising new SSH agent..."
    /usr/bin/ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
    echo succeeded
    chmod 600 "${SSH_ENV}"
    . "${SSH_ENV}" > /dev/null
    /usr/bin/ssh-add;
}

# Source SSH settings, if applicable

if [ -f "${SSH_ENV}" ]; then
    . "${SSH_ENV}" > /dev/null
    ps -ef | grep ${SSH_AGENT_PID} | grep ssh-agent$ > /dev/null || {
        start_agent;
    }
else
    start_agent;
fi
